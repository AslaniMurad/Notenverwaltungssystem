<%
  const page = {
    title: `Lehrer — Klassenstatistiken (${classData.name})`,
    headerTitle: 'Lehrerbereich',
    styles: ['/css/teacher-pages.css'],
    scripts: ['/js/app.js'],
    bodyClass: 'page-teacher',
    hideHeader: true,
    hideFooter: true,
    content: function () { %>
    <div class="app-shell teacher-shell">
      <aside class="teacher-sidebar" aria-label="Lehrer Navigation">
        <div class="sidebar-brand">
          <div>
            <div class="sidebar-title">Teacher Panel</div>
            <div class="sidebar-meta"><%= email %> · Lehrer</div>
          </div>
          <span class="sidebar-badge">Eingeloggt</span>
        </div>

        <div class="app-nav">
          <div class="nav-section">
            <div class="nav-section-title">Navigation</div>
            <a href="/teacher/classes">Meine Klassen</a>
            <a href="/teacher/create-class">Klasse erstellen</a>
            <div class="nav-section-title">Klasse: <%= classData.name %> / <%= classData.subject %></div>
            <a href="/teacher/students/<%= classData.id %>">Schüler</a>
            <a href="/teacher/grades/<%= classData.id %>">Noten</a>
            <a href="/teacher/special-assessments/<%= classData.id %>">Sonderleistungen</a>
            <a href="/teacher/grade-templates/<%= classData.id %>">Prüfungen</a>
            <a class="is-active" href="/teacher/class-statistics/<%= classData.id %>">Statistiken</a>
            <form class="logout-form" method="POST" action="/logout">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <button class="app-nav-link" type="submit">Logout</button>
            </form>
          </div>
        </div>
      </aside>

      <section class="teacher-main">
        <header class="teacher-main-header">
          <div>
            <p class="teacher-eyebrow">Klasse <%= classData.name %></p>
            <h1>Klassenstatistiken</h1>
            <p class="teacher-muted">Fach: <%= classData.subject %> · <%= studentCount %> Schüler</p>
          </div>
          <div class="teacher-actions-inline">
            <a class="btn btn-secondary" href="/teacher/classes">Zurück</a>
          </div>
        </header>

        <!-- Gesamtübersicht -->
        <% if (overallWeightedAverage || overallAverage) { %>
          <div class="stats-card">
            <div class="stat-item">
              <p class="stat-label">Klassendurchschnitt (gewichtet)</p>
              <p class="stat-value grade-<%= Math.round(overallWeightedAverage) %>">
                <%= overallWeightedAverage || '—' %>
              </p>
            </div>
            <div class="stat-item">
              <p class="stat-label">Durchschnitt (ungewichtet)</p>
              <p class="stat-value"><%= overallAverage || '—' %></p>
            </div>
            <div class="stat-item">
              <p class="stat-label">Anzahl Prüfungen</p>
              <p class="stat-value"><%= templateStats.length %></p>
            </div>
            <div class="stat-item">
              <p class="stat-label">Anzahl Schüler</p>
              <p class="stat-value"><%= studentCount %></p>
            </div>
          </div>
        <% } %>

        <div class="teacher-card">
          <div class="teacher-card-header">
            <div>
              <p class="teacher-eyebrow">Prüfungsstatistiken</p>
              <h3>Durchschnitt pro Prüfung</h3>
            </div>
            <div class="teacher-meta-chip"><%= templateStats.length %> Prüfungen</div>
          </div>

          <div class="statistics-list">
            <% if (templateStats.length === 0) { %>
              <div class="teacher-empty">
                <h4>Noch keine Prüfungen</h4>
                <p>Erstelle Prüfungsvorlagen, um Statistiken zu sehen.</p>
                <a class="btn btn-primary" href="/teacher/grade-templates/<%= classData.id %>">Prüfungen verwalten</a>
              </div>
            <% } else { %>
              <% templateStats.forEach(stat => { %>
                <div class="statistics-item">
                  <div class="statistics-item-header">
                    <div class="statistics-item-title-row">
                      <span class="grade-category-badge <%= stat.category.toLowerCase() %>"><%= stat.category %></span>
                      <h4 class="statistics-item-title"><%= stat.name %></h4>
                      <span class="weight-badge-small"><%= stat.weight %>%</span>
                      <% if (stat.date) { %>
                        <span class="grade-date"><%= new Date(stat.date).toLocaleDateString('de-DE') %></span>
                      <% } %>
                    </div>
                  </div>

                  <div class="statistics-item-body">
                    <div class="statistics-grid">
                      <div class="statistics-box">
                        <p class="statistics-label">Durchschnitt</p>
                        <% if (stat.average) { %>
                          <p class="statistics-value grade-<%= Math.round(stat.average) %>">
                            <%= stat.average %>
                          </p>
                        <% } else { %>
                          <p class="statistics-value-empty">—</p>
                        <% } %>
                      </div>

                      <div class="statistics-box">
                        <p class="statistics-label">Benotet</p>
                        <p class="statistics-value-small">
                          <%= stat.graded_count %> / <%= studentCount %>
                        </p>
                        <% if (stat.graded_count < studentCount) { %>
                          <p class="statistics-hint"><%= studentCount - stat.graded_count %> offen</p>
                        <% } %>
                      </div>

                      <div class="statistics-box">
                        <p class="statistics-label">Beste Note</p>
                        <% if (stat.best_grade) { %>
                          <p class="statistics-value-small grade-<%= Math.round(stat.best_grade) %>">
                            <%= stat.best_grade %>
                          </p>
                          <p class="statistics-hint">
                            <%= stat.best_students.slice(0, 2).join(', ') %>
                            <% if (stat.best_students.length > 2) { %>
                              +<%= stat.best_students.length - 2 %>
                            <% } %>
                          </p>
                        <% } else { %>
                          <p class="statistics-value-empty">—</p>
                        <% } %>
                      </div>

                      <div class="statistics-box">
                        <p class="statistics-label">Schlechteste Note</p>
                        <% if (stat.worst_grade) { %>
                          <p class="statistics-value-small grade-<%= Math.round(stat.worst_grade) %>">
                            <%= stat.worst_grade %>
                          </p>
                          <p class="statistics-hint">
                            <%= stat.worst_students.slice(0, 2).join(', ') %>
                            <% if (stat.worst_students.length > 2) { %>
                              +<%= stat.worst_students.length - 2 %>
                            <% } %>
                          </p>
                        <% } else { %>
                          <p class="statistics-value-empty">—</p>
                        <% } %>
                      </div>
                    </div>
                  </div>
                </div>
              <% }) %>
            <% } %>
          </div>
        </div>
      </section>
    </div>
<% } };
%>
<%- include('../layout', page) %>
